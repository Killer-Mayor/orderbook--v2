{% extends "base.html" %}
{% block title %}New Order{% endblock %}

{% block content %}
<div class="card shadow-sm">
  <div class="card-body">
    <h4 class="mb-3">Create Order</h4>

    <form method="post" action="/submit">
      <div class="mb-3">
        <label class="form-label">Company</label>
        <input name="company" list="companies" class="form-control" required>
        <datalist id="companies">
          {% for c in companies %}<option value="{{ c }}">{% endfor %}
        </datalist>
      </div>

      <table class="table table-bordered">
        <thead class="table-light">
          <tr>
            <th>Product</th>
            <th>Brand</th>
            <th width="120">Qty</th>
            <th width="140">Price</th>
            <th width="80"></th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr>
            <td><input name="orders[0][product]" list="products" class="form-control" required></td>
            <td><input name="orders[0][brand]" list="brands" class="form-control"></td>
            <td><input name="orders[0][quantity]" type="number" min="1" class="form-control" required></td>
            <td><input name="orders[0][price]" type="number" step="0.01" class="form-control" required></td>
            <td><button type="button" class="btn btn-danger btn-sm remove">✕</button></td>
          </tr>
        </tbody>
      </table>

      <button type="button" class="btn btn-secondary mb-3" id="addRow">+ Add Item</button>

      <datalist id="products">
        {% for p in products %}<option value="{{ p }}">{% endfor %}
      </datalist>

      <datalist id="brands">
        {% for b in brands %}<option value="{{ b }}">{% endfor %}
      </datalist>

      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" name="includes_gst">
        <label class="form-check-label">Prices include GST (5%)</label>
      </div>

      <button class="btn btn-primary">Submit Order</button>
    </form>
  </div>
</div>

<hr class="my-4">

<h5>Recent Orders</h5>
<div id="undoBanner" class="alert alert-warning d-none mt-3">
  Order deleted.
  <button class="btn btn-sm btn-outline-dark ms-2" onclick="undoDelete()">
    Undo
  </button>
</div>
<div class="table-responsive">
  <table class="table table-bordered table-sm align-middle">
    <thead class="table-light">
      <tr>
        <th>Serial</th>
        <th>Company</th>
        <th>Product</th>
        <th>Brand</th>
        <th>Qty</th>
        <th>Price</th>
        <th>Total</th>
        <th width="140">Action</th>
      </tr>
    </thead>
    <tbody id="recentOrdersBody">
      <tr>
        <td colspan="7" class="text-muted text-center">Loading…</td>
      </tr>
    </tbody>
  </table>
</div>



{% endblock %}

{% block extra_js %}
<script>
let idx = 1;
document.getElementById('addRow').onclick = () => {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input name="orders[${idx}][product]" list="products" class="form-control" required></td>
    <td><input name="orders[${idx}][brand]" list="brands" class="form-control"></td>
    <td><input name="orders[${idx}][quantity]" type="number" class="form-control" required></td>
    <td><input name="orders[${idx}][price]" type="number" step="0.01" class="form-control" required></td>
    <td><button type="button" class="btn btn-danger btn-sm remove">✕</button></td>
  `;
  document.getElementById('rows').appendChild(tr);
  idx++;
};

document.addEventListener('click', e => {
  if (e.target.classList.contains('remove')) {
    e.target.closest('tr').remove();
  }
});
const recentBody = document.getElementById('recentOrdersBody');

function loadRecentOrders() {
  fetch('/api/recent_orders')
    .then(r => r.json())
    .then(d => renderRecent(d.orders));
}

function renderRecent(rows) {
  recentBody.innerHTML = '';

  if (!rows.length) {
    recentBody.innerHTML = `
      <tr><td colspan="7" class="text-muted text-center">No recent orders</td></tr>`;
    return;
  }

  rows.forEach(o => {
    recentBody.innerHTML += `
      <tr>
        <td>${o.serial}</td>
        <td>${o.company}</td>
        <td><input class="form-control form-control-sm" value="${o.product}" data-row="${o.row}" data-key="product"></td>
        <td><input class="form-control form-control-sm" value="${o.brand}" data-row="${o.row}" data-key="brand"></td>
        <td><input type="number" class="form-control form-control-sm" value="${o.quantity}" data-row="${o.row}" data-key="quantity"></td>
        <td><input type="number" step="0.01" class="form-control form-control-sm" value="${o.price}" data-row="${o.row}" data-key="price"></td>
        <td>${(o.quantity * o.price * 1.05).toFixed(2)}</td>
        <td>
          <button class="btn btn-sm btn-success" onclick="saveRow(${o.row}, this)">Save</button>
          <button class="btn btn-sm btn-danger" onclick="deleteRow(${o.row})">Delete</button>
        </td>
      </tr>`;
  });
}

function saveRow(row, btn) {
  const inputs = document.querySelectorAll(`[data-row="${row}"]`);
  const payload = { row };

  inputs.forEach(i => payload[i.dataset.key] = i.value);

  fetch('/api/update_order', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  }).then(() => {
    btn.textContent = 'Saved';
    setTimeout(() => btn.textContent = 'Save', 1000);
  });
}

let lastDeleted = null;

function deleteRow(row) {
  if (!confirm('Delete this order entry?')) return;

  // Capture current row data for undo
  const inputs = document.querySelectorAll(`[data-row="${row}"]`);
  const snapshot = { row, data: {} };

  inputs.forEach(i => {
    snapshot.data[i.dataset.key] = i.value;
  });

  snapshot.data.date = new Date().toISOString().split('T')[0];
  snapshot.data.company = inputs[0].closest('tr').children[1].innerText;

  fetch('/api/delete_order', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ row })
  }).then(() => {
    lastDeleted = snapshot;
    showUndoBanner();
    loadRecentOrders();
  });
}
function showUndoBanner() {
  const banner = document.getElementById('undoBanner');
  banner.classList.remove('d-none');

  setTimeout(() => {
    banner.classList.add('d-none');
    lastDeleted = null;
  }, 10000); // 10 seconds
}

function undoDelete() {
  if (!lastDeleted) return;

  fetch('/api/undo_delete_order', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(lastDeleted)
  }).then(() => {
    lastDeleted = null;
    document.getElementById('undoBanner').classList.add('d-none');
    loadRecentOrders();
  });
}

loadRecentOrders();
</script>
{% endblock %}
