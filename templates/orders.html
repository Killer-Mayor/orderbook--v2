{% extends "base.html" %}
{% block title %}View Orders{% endblock %}

{% block content %}
<h4 class="mb-3">Pending Orders</h4>

<!-- FILTERS -->
<div class="card mb-3">
  <div class="card-body">
    <div class="row g-3">

      <!-- PRODUCT FILTER -->
      <div class="col-md-6 position-relative">
        <label class="form-label">Filter Products</label>
        <input id="productInput" class="form-control" placeholder="Type or select product…">
        <div id="productDropdown" class="list-group position-absolute w-100 d-none"></div>
        <div id="productChips" class="mt-2"></div>
      </div>

      <!-- PARTY FILTER -->
      <div class="col-md-6 position-relative">
        <label class="form-label">Filter Parties</label>
        <input id="partyInput" class="form-control" placeholder="Type or select party…">
        <div id="partyDropdown" class="list-group position-absolute w-100 d-none"></div>
        <div id="partyChips" class="mt-2"></div>
      </div>

    </div>

    <div class="mt-3 text-end">
      <button id="clearFilters" class="btn btn-outline-secondary">
        Clear Filters
      </button>
    </div>
  </div>
</div>

<!-- TABLE -->
<div class="table-responsive">
  <table class="table table-bordered table-sm">
    <thead class="table-light">
      <tr id="tableHeader">
        <th>Party\products</th>
      </tr>
    </thead>
    <tbody id="tableBody">
      <tr>
        <td colspan="100%" class="text-muted text-center">
          Loading pending orders…
        </td>
      </tr>
    </tbody>
  </table>
</div>
<h5 class="mt-4">Inventory Requirement</h5>

<table class="table table-bordered table-sm">
  <thead>
    <tr>
      <th>Width</th>
      <th>Thickness</th>
      <th> qty </th>
      <th>Total Weight</th>
    </tr>
  </thead>
  <tbody id="inventoryBody">
        <tr>
        <td colspan="100%" class="text-muted text-center">
          Loading pending orders…
        </td>
      </tr>
    </tbody>
</table>

{% endblock %}

{% block extra_js %}
<script>
/* ---------------- STATE ---------------- */
let ALL_PRODUCTS = [];
let ALL_PARTIES = [];

let selectedProducts = [];
let selectedParties = [];

const body = document.getElementById('tableBody');
const header = document.getElementById('tableHeader');

/* ---------------- ELEMENTS ---------------- */
const productInput = document.getElementById('productInput');
const productDropdown = document.getElementById('productDropdown');
const productChips = document.getElementById('productChips');

const partyInput = document.getElementById('partyInput');
const partyDropdown = document.getElementById('partyDropdown');
const partyChips = document.getElementById('partyChips');

/* ---------------- NORMALIZE ---------------- */
function norm(s) {
  return s.toLowerCase();
}

/* ---------------- CHIPS ---------------- */
function addChip(container, value, list) {
  if (list.includes(value)) return;
  list.push(value);

  const chip = document.createElement('span');
  chip.className = 'badge bg-primary me-2 mb-1';
  chip.innerHTML = `${value} <span style="cursor:pointer;">×</span>`;
  chip.onclick = () => {
    list.splice(list.indexOf(value), 1);
    chip.remove();
    loadPivot();
  };
  container.appendChild(chip);
  loadPivot();
}

/* ---------------- DROPDOWN + TYPE ---------------- */
function setupFilter(input, dropdown, dataFn, chipsContainer, selectedList) {

  function renderDropdown(query = '') {
    dropdown.innerHTML = '';
    const q = norm(query);

    dataFn()
      .filter(x => norm(x).includes(q) && !selectedList.includes(x))
      .forEach(item => {
        const div = document.createElement('div');
        div.className = 'list-group-item list-group-item-action';
        div.textContent = item;
        div.onclick = () => {
          addChip(chipsContainer, item, selectedList);
          input.value = '';
          dropdown.classList.add('d-none');
        };
        dropdown.appendChild(div);
      });

    dropdown.classList.toggle('d-none', dropdown.children.length === 0);
  }

  input.onfocus = () => renderDropdown('');
  input.oninput = () => renderDropdown(input.value);
  input.onblur = () => setTimeout(() => dropdown.classList.add('d-none'), 150);
}

/* ---------------- LOAD INITIAL PIVOT (SOURCE OF TRUTH) ---------------- */
function initFilters() {
  fetch('/api/pivot_data')
    .then(r => r.json())
    .then(d => {
      ALL_PRODUCTS = d.products;
      ALL_PARTIES = d.parties;
      loadPivot();
    });
  fetch('/api/inventory_requirements')
  .then(r => r.json())
  .then(d => {
    const body = document.getElementById('inventoryBody');
    body.innerHTML = '';

    d.inventory.forEach(i => {
      body.innerHTML += `
        <tr>
          <td>${i.width}</td>
          <td>${i.thickness}</td>
          <td>${i.qty}</td>
          <td>${i.total_weight}</td>
        </tr>`;
    });
  });

}

/* ---------------- LOAD PIVOT ---------------- */
function loadPivot() {
  body.innerHTML = `<tr><td colspan="100%" class="text-muted text-center">Loading…</td></tr>`;
  header.innerHTML = `<th>Party</th>`;

  const url =
    `/api/pivot_data?product_filter=${encodeURIComponent([...selectedProducts].join(','))}` +
    `&party_filter=${encodeURIComponent([...selectedParties].join(','))}`;

  fetch(url)
    .then(r => r.json())
    .then(d => renderTable(d));
}

/* ---------------- RENDER TABLE ---------------- */
function renderTable(data) {
  header.innerHTML = `<th>Party\\\Products</th>`;
  body.innerHTML = '';

  if (!data.parties.length || !data.products.length) {
    body.innerHTML = `
      <tr>
        <td colspan="100%" class="text-muted text-center">
          No pending orders found
        </td>
      </tr>`;
    return;
  }

  // Build header
  data.products.forEach(p => {
    header.innerHTML += `<th class="text-center">${p}</th>`;
  });

// Prepare totals array
  const totals = Array(data.products.length).fill(0);

  // First pass: compute totals
  data.pivot.forEach(row => {
    row.forEach((qty, j) => {
      if (qty > 0) totals[j] += qty;
    });
  });

  // Render totals row FIRST
  let totalRow = `<tr class="table-dark fw-bold"><th>TOTAL</th>`;
  totals.forEach(t => {
    totalRow += `<td class="text-center">${t > 0 ? t : '-'}</td>`;
  });
  totalRow += `</tr>`;

  body.innerHTML += totalRow;

  // Render party rows
  data.parties.forEach((party, i) => {
    let row = `<tr><th>${party}</th>`;

    data.pivot[i].forEach((qty, j) => {
      if (qty > 0) {
        row += `<td class="text-center bg-warning fw-bold">${qty}</td>`;
      } else {
        row += `<td class="text-center">-</td>`;
      }
    });

    row += `</tr>`;
    body.innerHTML += row;
  });
}

/* ---------------- CLEAR ---------------- */
document.getElementById('clearFilters').onclick = () => {
selectedProducts= [];
selectedParties =[];
document.getElementById('productTags').innerHTML = '';
document.getElementById('partyTags').innerHTML = '';
loadPivot();
};

/* ---------------- INIT ---------------- */
setupFilter(productInput, productDropdown, () => ALL_PRODUCTS, productChips, selectedProducts);
setupFilter(partyInput, partyDropdown, () => ALL_PARTIES, partyChips, selectedParties);

initFilters();
</script>
{% endblock %}
